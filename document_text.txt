 智能假设检验分析服务 LLM-Powered Statistical Analysis Platform 技术设计文档 v2.0 文档版本：2.0（增强大模型能力） 创建日期：2025年1月 1. 项目概述 1.1 背景与目标 本服务结合大语言模型（LLM）与统计分析引擎，提供智能化的假设检验分析能力。用户可通过自然语言描述分析需求，系统自动理解意图、执行检验、并生成业务化的分析报告。 1.2 核心价值主张 能力 价值 自然语言交互 无需了解统计术语，用业务语言描述分析需求 智能方法选择 LLM 结合数据特征，自动推荐最优检验方法 业务化解读 将 p 值、效应量转化为可执行的业务洞察 多轮对话分析 支持追问、调整参数、对比分析的连续交互 主动分析建议 发现潜在混杂变量、提示数据质量问题 2. 系统架构 2.1 整体架构 系统采用 LLM 驱动的智能分析架构，核心流程为&quot;理解→规划→执行→解读&quot;： ┌──────────────────────────────────────────────────────────────┐&#10;│ 用户交互层 │&#10;│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │&#10;│ │ 自然语言 │ │ 文件上传 │ │ API调用 │ │&#10;│ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ │&#10;└─────────┼────────────────┼────────────────┼──────────────────┘&#10; │ │ │&#10; ▼ ▼ ▼&#10;┌──────────────────────────────────────────────────────────────┐&#10;│ LLM 智能层 │&#10;│ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │&#10;│ │ 意图理解 │─▶│ 分析规划 │─▶│ 结果解读 │ │&#10;│ │ Intent │ │ Planning │ │ Interpret │ │&#10;│ └─────────────┘ └─────────────┘ └─────────────┘ │&#10;└──────────────────────────┬───────────────────────────────────┘&#10; │&#10; ▼&#10;┌──────────────────────────────────────────────────────────────┐&#10;│ 统计分析引擎 │&#10;│ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │&#10;│ │类型识别 │ │正态检验 │ │假设检验 │ │效应计算 │ │&#10;│ └──────────┘ └──────────┘ └──────────┘ └──────────┘ │&#10;└──────────────────────────────────────────────────────────────┘ 2.2 技术栈选型 层级 技术选型 说明 大语言模型 Claude API / GPT-4 意图理解、分析规划、结果解读 Agent 框架 LangChain / LlamaIndex 工具调用、多轮对话、记忆管理 API 框架 FastAPI 高性能异步，自动 OpenAPI 文档 统计计算 SciPy + Statsmodels 假设检验、回归分析、效应量计算 会话存储 Redis 多轮对话上下文、分析会话状态 3. LLM 智能层设计 3.1 意图理解模块 将用户自然语言转换为结构化分析任务： 用户输入 LLM 解析结果 &quot;广告费对销售额有影响吗？&quot; X=广告费, Y=销售额, 任务=显著性检验 &quot;男女员工的绩效有差异吗？&quot; X=性别, Y=绩效, 任务=组间差异检验 &quot;哪些因素影响客户流失？&quot; X=所有特征, Y=流失标记, 任务=多因子筛选 &quot;去掉异常值再分析一次&quot; 任务=重复上次分析, 预处理=移除异常值 Prompt 设计示例 你是一个统计分析助手。根据用户问题，提取以下信息：&#10;1. 自变量(X)：用户想要检验的影响因素&#10;2. 因变量(Y)：用户关心的结果变量&#10;3. 分析任务：显著性检验/组间差异/相关性/多因子筛选&#10;4. 特殊要求：数据预处理、置信水平、检验方向等&#10;&#10;用户问题：{user_query}&#10;数据列名：{column_names}&#10;&#10;请以 JSON 格式输出解析结果。 3.2 分析规划模块 LLM 结合数据元信息，生成分析执行计划： 数据探查： 读取数据摘要（行数、列类型、缺失率、分布） 前提检验： 规划正态性、方差齐性等前提条件检验 方法选择： 根据数据特征选择最优检验方法 补充分析： 规划效应量、置信区间、事后检验等 Tool Calling 设计 tools = [&#10; {&#10; &quot;name&quot;: &quot;get_data_summary&quot;,&#10; &quot;description&quot;: &quot;获取数据集摘要统计信息&quot;,&#10; &quot;parameters&quot;: {&quot;columns&quot;: &quot;list[str]&quot;}&#10; },&#10; {&#10; &quot;name&quot;: &quot;run_normality_test&quot;,&#10; &quot;description&quot;: &quot;执行正态性检验&quot;,&#10; &quot;parameters&quot;: {&quot;column&quot;: &quot;str&quot;, &quot;method&quot;: &quot;shapiro|dagostino&quot;}&#10; },&#10; {&#10; &quot;name&quot;: &quot;run_hypothesis_test&quot;,&#10; &quot;description&quot;: &quot;执行假设检验&quot;,&#10; &quot;parameters&quot;: {&#10; &quot;x_col&quot;: &quot;str&quot;,&#10; &quot;y_col&quot;: &quot;str&quot;,&#10; &quot;method&quot;: &quot;ttest|anova|chi2|regression|...&quot;&#10; }&#10; },&#10; {&#10; &quot;name&quot;: &quot;calculate_effect_size&quot;,&#10; &quot;description&quot;: &quot;计算效应量&quot;,&#10; &quot;parameters&quot;: {&quot;method&quot;: &quot;cohens_d|eta_squared|r_squared&quot;}&#10; }&#10;] 3.3 结果解读模块 将统计结果转化为业务语言报告： 统计输出 LLM 业务解读 p = 0.003, Cohen's d = 0.8 广告费对销售额有显著正向影响，效果较强。每增加1万广告费，销售额平均提升约12%。 p = 0.42, η² = 0.02 男女员工绩效无显著差异，性别仅解释2%的绩效变异，建议关注其他因素。 Shapiro p = 0.001 数据不符合正态分布，已自动切换为非参数检验（Mann-Whitney U），结果更可靠。 3.4 多轮对话支持 通过会话状态管理实现连续分析交互： 会话状态结构：&#10;{&#10; &quot;session_id&quot;: &quot;uuid&quot;,&#10; &quot;data_context&quot;: {&#10; &quot;file_id&quot;: &quot;...&quot;,&#10; &quot;columns&quot;: [...],&#10; &quot;summary&quot;: {...}&#10; },&#10; &quot;analysis_history&quot;: [&#10; {&quot;query&quot;: &quot;...&quot;, &quot;result&quot;: {...}, &quot;timestamp&quot;: &quot;...&quot;}&#10; ],&#10; &quot;current_focus&quot;: {&#10; &quot;x_col&quot;: &quot;广告费&quot;,&#10; &quot;y_col&quot;: &quot;销售额&quot;&#10; }&#10;} 支持的追问类型： &quot;换个方法试试&quot; → 使用备选检验方法重新分析 &quot;去掉异常值&quot; → 应用 IQR/Z-score 过滤后重跑 &quot;再看看地区的影响&quot; → 切换 X 变量 &quot;分组看看&quot; → 按类别分层分析 &quot;控制年龄因素&quot; → 加入协变量（ANCOVA） 4. 统计分析引擎 4.1 检验方法矩阵 X 类型 Y 连续正态 Y 连续非正态 Y 离散 连续 Pearson + 回归 Spearman 相关 Logistic 回归 离散 (2组) 独立样本 t 检验 Mann-Whitney U 卡方 / Fisher 离散 (≥3组) ANOVA + Tukey Kruskal-Wallis 卡方检验 4.2 效应量计算 检验类型 效应量指标 解读标准 t 检验 Cohen's d 小 0.2 / 中 0.5 / 大 0.8 ANOVA η² (Eta squared) 小 0.01 / 中 0.06 / 大 0.14 相关/回归 R² / r 小 0.1 / 中 0.3 / 大 0.5 卡方检验 Cramér's V 小 0.1 / 中 0.3 / 大 0.5 5. API 接口设计 5.1 核心接口 方法 路径 说明 POST /api/v2/chat 自然语言对话分析（主入口） POST /api/v2/upload 上传数据文件，返回会话 ID POST /api/v2/analyze 结构化分析（指定 X/Y/方法） GET /api/v2/session/{id} 获取会话历史与分析结果 5.2 对话接口详情 POST /api/v2/chat // 请求&#10;{&#10; &quot;session_id&quot;: &quot;uuid&quot;, // 会话ID（首次可空）&#10; &quot;message&quot;: &quot;广告费对销售额有影响吗？&quot;,&#10; &quot;file&quot;: &quot;base64...&quot; // 首次上传数据（可选）&#10;}&#10;&#10;// 响应&#10;{&#10; &quot;session_id&quot;: &quot;uuid&quot;,&#10; &quot;reply&quot;: &quot;分析结果显示，广告费对销售额有显著正向影响...&quot;,&#10; &quot;analysis&quot;: {&#10; &quot;method&quot;: &quot;linear_regression&quot;,&#10; &quot;p_value&quot;: 0.003,&#10; &quot;effect_size&quot;: {&quot;r_squared&quot;: 0.42},&#10; &quot;significant&quot;: true&#10; },&#10; &quot;suggestions&quot;: [&#10; &quot;建议控制季节因素后再次验证&quot;,&#10; &quot;可以尝试分地区查看效果差异&quot;&#10; ],&#10; &quot;visualizations&quot;: [&quot;scatter_plot_url&quot;, &quot;residual_plot_url&quot;]&#10;} 6. 智能分析流程 完整的 LLM 驱动分析流程： 接收输入： 用户自然语言 + 数据文件 意图解析： LLM 提取 X/Y 变量、分析任务、特殊要求 数据探查： 生成数据摘要，检测异常值和缺失 分析规划： LLM 结合数据特征，规划检验步骤 执行检验： 调用统计引擎，获取原始结果 结果解读： LLM 生成业务化报告和建议 状态更新： 保存会话上下文，支持后续追问 7. 部署与成本 7.1 部署架构 ┌─────────────────────────────────────────────────────┐&#10;│ Kubernetes │&#10;│ ┌───────────┐ ┌───────────┐ ┌───────────┐ │&#10;│ │ API Pod │ │ API Pod │ │ Worker Pod│ │&#10;│ │ (FastAPI) │ │ (FastAPI) │ │ (Celery) │ │&#10;│ └─────┬─────┘ └─────┬─────┘ └─────┬─────┘ │&#10;│ └───────────┬──┴──────────────┘ │&#10;│ ▼ │&#10;│ ┌─────────────────────────────────────────────┐ │&#10;│ │ Redis (会话 + 任务队列) │ │&#10;│ └─────────────────────────────────────────────┘ │&#10;└─────────────────────────────────────────────────────┘&#10; │&#10; ┌──────────────┼──────────────┐&#10; ▼ ▼ ▼&#10; ┌────────────┐ ┌────────────┐ ┌────────────┐&#10; │ Claude API │ │ 对象存储 │ │ PostgreSQL │&#10; │ (LLM) │ │ (文件) │ │ (元数据) │&#10; └────────────┘ └────────────┘ └────────────┘ 7.2 成本估算 资源 规格 单价 月成本 LLM API Claude Sonnet $3/M tokens $300-800 计算节点 4C8G × 2 $0.15/h $220 Redis 2GB $25/月 $25 合计 $550-1050 8. 扩展规划 8.1 v2.1 - 增强分析 因果推断集成（DoWhy）：区分相关性与因果性 异常值智能处理：IsolationForest 自动检测并提示 交互式可视化：Plotly 图表嵌入报告 8.2 v2.2 - 多模态 图片输入：截图数据表格自动 OCR 提取 语音交互：支持语音描述分析需求 报告导出：一键生成 PDF/PPT 分析报告 8.3 v3.0 - 平台化 BI 集成：Superset/Metabase 插件 数据源直连：支持 MySQL/PostgreSQL/API 数据源 定时监控：设置阈值自动告警（如 p 值变化） 附录：项目结构 hypothesis-testing-service-v2/&#10;├── app/&#10;│ ├── main.py # FastAPI 入口&#10;│ ├── api/&#10;│ │ ├── routes.py # 路由定义&#10;│ │ ├── chat.py # 对话接口&#10;│ │ └── schemas.py # 请求/响应模型&#10;│ ├── llm/&#10;│ │ ├── agent.py # LLM Agent 主逻辑&#10;│ │ ├── intent_parser.py # 意图理解&#10;│ │ ├── planner.py # 分析规划&#10;│ │ ├── interpreter.py # 结果解读&#10;│ │ ├── tools.py # Tool Calling 定义&#10;│ │ └── prompts/ # Prompt 模板&#10;│ │ ├── intent.txt&#10;│ │ ├── planning.txt&#10;│ │ └── interpret.txt&#10;│ ├── engine/&#10;│ │ ├── analyzer.py # 分析引擎入口&#10;│ │ ├── data_types.py # 类型识别&#10;│ │ ├── normality.py # 正态性检验&#10;│ │ ├── effect_size.py # 效应量计算&#10;│ │ └── tests/ # 各类检验实现&#10;│ │ ├── t_test.py&#10;│ │ ├── anova.py&#10;│ │ ├── chi_square.py&#10;│ │ └── regression.py&#10;│ ├── session/&#10;│ │ ├── manager.py # 会话管理&#10;│ │ └── redis_store.py # Redis 存储&#10;│ └── utils/&#10;│ ├── data_loader.py # 数据加载&#10;│ └── validators.py # 输入校验&#10;├── tests/&#10;├── Dockerfile&#10;├── docker-compose.yml&#10;├── requirements.txt&#10;└── README.md 
