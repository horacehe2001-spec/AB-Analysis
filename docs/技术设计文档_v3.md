# 统计分析平台 — 技术设计文档

---

## 1. 文档信息

| 项目 | 内容 |
|------|------|
| 文档版本 | V3.0 |
| 更新日期 | 2026-01-31 |
| 文档性质 | 技术设计文档 |
| 适用范围 | 统计分析平台（前后端全栈） |

---

## 2. 系统架构概览

### 2.1 架构图

```
┌──────────┐     ┌─────────────────┐     ┌──────────────────┐     ┌─────────────────────────────────┐     ┌──────────┐
│          │     │    Frontend      │     │    Backend        │     │          核心引擎               │     │          │
│   用户   │────▶│  React 18 + TS  │────▶│  FastAPI          │────▶│  SciPy / Statsmodels / SPC     │     │  SQLite  │
│          │     │  MUI v5         │     │  Uvicorn          │     │  Pandas / NumPy / Matplotlib   │     │          │
│          │     │  ECharts        │     │                    │     └─────────────────────────────────┘     │          │
│          │     │  Zustand        │     │                    │────▶┌─────────────────────────────────┐     │          │
│          │     │                 │     │                    │     │  LLM 服务（可选）               │     │          │
│          │     │   Axios ───────────▶  │  API v2           │     │  OpenAI / Anthropic / 智谱 / 通义│     │          │
└──────────┘     └─────────────────┘     └────────┬───────────┘     └─────────────────────────────────┘     └──────────┘
                                                  │                                                           ▲
                                                  └───────────────────────────────────────────────────────────┘
```

**数据流向：** 用户 → 前端（React） → API 客户端（Axios） → 后端（FastAPI） → 分析引擎（SciPy/Statsmodels/SPC）+ LLM（可选） → SQLite

### 2.2 技术栈

#### 后端

| 类别 | 技术 |
|------|------|
| Web 框架 | FastAPI |
| ORM | SQLAlchemy |
| 数据处理 | Pandas, NumPy |
| 统计分析 | SciPy, Statsmodels |
| 图表渲染 | Matplotlib |
| 文档生成 | python-docx |
| 编码检测 | chardet |
| HTTP 客户端 | httpx |

#### 前端

| 类别 | 技术 |
|------|------|
| 框架 | React 18 + TypeScript |
| UI 组件库 | MUI v5 (Material UI) |
| 状态管理 | Zustand |
| 图表 | ECharts |
| HTTP 客户端 | Axios |
| 路由 | React Router v6 |

#### 基础设施

| 类别 | 技术 |
|------|------|
| 数据库 | SQLite |
| 容器化 | Docker |
| ASGI 服务器 | Uvicorn |

---

## 3. 后端设计

### 3.1 目录结构

```
D:\AB\backend\
├── main.py                  # FastAPI 应用入口
├── api/                     # API 路由层
│   └── v2/                  # v2 版本接口
├── models/                  # SQLAlchemy 数据模型
├── engine/
│   ├── methods.py           # 统计检验方法
│   └── spc.py               # SPC 控制图分析
├── llm/
│   ├── client.py            # 多供应商 LLM 客户端
│   └── intent.py            # 意图解析器
├── planner.py               # 意图→计划映射
├── exporter.py              # 报告导出服务
├── data_loader.py           # 数据加载器
├── data_summary.py          # 数据摘要与列类型推断
└── database.py              # 数据库连接配置
```

### 3.2 API 接口设计

| 路径 | 方法 | 说明 |
|------|------|------|
| `/api/v2/chat` | POST | 主分析接口，接受自然语言或 JSON 格式输入，返回统计分析结果 |
| `/api/v2/upload` | POST | 文件上传，支持 CSV / Excel / TXT 格式 |
| `/api/v2/sessions` | GET | 获取会话列表，支持分页与筛选 |
| `/api/v2/session/{id}` | GET | 获取指定会话详情 |
| `/api/v2/session/{id}` | DELETE | 软删除会话（设置 deleted_at 时间戳） |
| `/api/v2/export` | POST | 导出分析报告（Markdown → ZIP 压缩包，含 PNG 图片与 DOCX 文档） |
| `/api/v2/download/{session_id}/{file_name}` | GET | 下载指定会话下的文件 |
| `/api/v2/report/conclusion` | POST | 调用 LLM 生成分析结论 |
| `/api/v2/config/model` | GET | 获取当前模型配置 |
| `/api/v2/config/model` | PUT | 更新模型配置 |
| `/api/v2/config/model/test` | POST | 测试 LLM 连接是否正常 |
| `/api/v2/config/prompts` | GET | 获取提示词模板 |
| `/api/v2/config/prompts` | PUT | 更新提示词模板 |

### 3.3 数据库设计

#### SessionModel — 会话表

| 字段 | 类型 | 说明 |
|------|------|------|
| `session_id` | UUID (PK) | 会话唯一标识，主键 |
| `file_name` | String | 上传的文件名 |
| `file_uri` | String | 文件存储路径 |
| `industry` | String | 所属行业 |
| `data_summary` | JSON | 数据摘要信息（列类型、统计量等） |
| `report_conclusion` | Text | LLM 生成的报告结论 |
| `messages` | Relationship | 关联的消息列表（一对多） |
| `created_at` | DateTime | 创建时间 |
| `updated_at` | DateTime | 最后更新时间 |
| `deleted_at` | DateTime | 软删除时间戳（为空表示未删除） |

#### MessageModel — 消息表

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | UUID (PK) | 消息唯一标识 |
| `session_id` | UUID (FK) | 关联的会话 ID，外键 |
| `role` | String | 消息角色（user / assistant / system） |
| `content` | Text | 消息内容 |
| `timestamp` | DateTime | 消息时间戳 |
| `analysis` | JSON | 分析结果（统计量、图表数据等） |

#### AppConfigModel — 应用配置表

| 字段 | 类型 | 说明 |
|------|------|------|
| `key` | String (PK) | 配置键名，主键 |
| `value` | JSON | 配置值 |
| `updated_at` | DateTime | 最后更新时间 |

### 3.4 分析引擎

#### 3.4.1 统计检验方法（engine/methods.py）

| 方法 | 函数名 | 适用场景 |
|------|--------|----------|
| t 检验 | `t_test` | 两组正态分布连续数据的均值比较 |
| Mann-Whitney U 检验 | `mann_whitney` | 两组非正态分布连续数据的差异比较 |
| 单因素方差分析 | `anova` | 三组及以上正态分布数据的均值比较 |
| Kruskal-Wallis 检验 | `kruskal` | 三组及以上非正态分布数据的差异比较 |
| 卡方检验 | `chi_square` | 分类变量间的独立性检验 |
| Pearson 相关 | `pearson` | 两个正态分布连续变量的线性相关性 |
| Spearman 相关 | `spearman` | 两个变量的单调相关性（不要求正态分布） |
| 线性回归 | `linear_regression` | 连续变量间的线性回归建模 |

#### 3.4.2 自动方法选择逻辑（suggest_default_method）

系统根据以下条件自动推荐合适的统计方法：

1. **变量类型判断：** 根据 `data_summary` 中的列类型推断（number / category / bool / datetime / text）
2. **分组数量：** 两组 → t 检验 / Mann-Whitney；三组及以上 → ANOVA / Kruskal-Wallis
3. **正态性检验：** 对连续数据执行 Shapiro-Wilk 检验，决定使用参数检验还是非参数检验
4. **变量组合：** 分类 × 分类 → 卡方检验；连续 × 连续 → 相关/回归分析

#### 3.4.3 SPC 控制图分析（engine/spc.py）

**支持的控制图类型（7 种）：**

| 图表类型 | 说明 | 适用场景 |
|----------|------|----------|
| IX-MR | 单值-移动极差图 | 子组大小为 1 的连续数据 |
| Xbar-R | 均值-极差图 | 子组大小 2~10 的连续数据 |
| Xbar-S | 均值-标准差图 | 子组大小 > 10 的连续数据 |
| P | 不合格品率图 | 不等样本量的计数型数据 |
| NP | 不合格品数图 | 等样本量的计数型数据 |
| C | 缺陷数图 | 等检验单位的缺陷计数 |
| U | 单位缺陷数图 | 不等检验单位的缺陷计数 |

**Western Electric 判异规则（8 条）：**

1. 单点超出控制限（3σ 外）
2. 连续 9 点在中心线同侧
3. 连续 6 点递增或递减
4. 连续 14 点交替上下波动
5. 连续 3 点中有 2 点在 2σ 外（同侧）
6. 连续 5 点中有 4 点在 1σ 外（同侧）
7. 连续 15 点在 1σ 内（中心线两侧）
8. 连续 8 点在 1σ 外（中心线两侧）

**控制限计算：** 使用标准 SPC 常数表（A2、A3、d2 等）进行控制限的计算。

### 3.5 LLM 集成

#### 3.5.1 多供应商客户端（llm/client.py）

支持以下 LLM 服务供应商：

- **OpenAI** — GPT 系列模型
- **Anthropic** — Claude 系列模型
- **智谱（Zhipu）** — GLM 系列模型
- **通义千问（Qwen）** — Qwen 系列模型
- **自定义（Custom）** — 兼容 OpenAI API 格式的自定义端点

#### 3.5.2 意图解析器（llm/intent.py）

采用**启发式规则 + LLM 混合**的意图解析策略：

1. **启发式匹配：** 通过关键词和模式匹配快速识别常见意图
2. **模糊列名匹配：** 将用户输入的列名与实际数据列名进行模糊匹配，容忍拼写差异
3. **LLM 辅助解析：** 对于无法通过规则识别的复杂意图，调用 LLM 进行理解

#### 3.5.3 计划器（planner.py）

将解析后的意图映射为执行计划：

| 任务提示（Task Hint） | 说明 |
|------------------------|------|
| `auto` | 自动选择分析方法 |
| `regression` | 回归分析 |
| `difference` | 差异检验 |
| `correlation` | 相关性分析 |
| `chi_square` | 卡方检验 |
| `spc` | SPC 控制图分析 |

计划器会自动填充缺失的参数（如变量列名、分组列名等）。

### 3.6 导出服务（exporter.py）

#### 输出格式

- **Markdown：** 返回文本内容及图片路径列表
- **DOCX：** 使用 python-docx 构建完整 Word 文档
- **ZIP：** 包含 DOCX 文件及所有 PNG 图片

#### 图表渲染（Matplotlib）

支持的图表类型：

- 散点图（scatter）
- 箱线图（box）
- 柱状图（bar）
- 分布图（distribution）
- 残差图（residual）
- 控制图（control_chart）

**中文字体支持：** 自动检测并配置系统中文字体，确保图表中的中文标签正确显示。

#### 报告结构

- **假设检验报告：** 6 步流程（提出假设 → 选择方法 → 检验前提 → 执行检验 → 判断结果 → 得出结论）
- **SPC 报告：** 5 步流程（数据准备 → 选择控制图 → 计算控制限 → 绘制控制图 → 判异分析）

---

## 4. 前端设计

### 4.1 目录结构

```
D:\AB\frontend\
├── src/
│   ├── pages/
│   │   ├── Home.tsx              # 主分析页面
│   │   ├── History.tsx           # 历史会话浏览
│   │   └── Settings.tsx          # 系统设置
│   ├── components/
│   │   ├── layout/
│   │   │   ├── Layout.tsx        # 全局布局
│   │   │   ├── Header.tsx        # 顶部导航栏
│   │   │   ├── Sidebar.tsx       # 侧边栏
│   │   │   └── ModuleSelector.tsx # 模块选择器
│   │   ├── upload/
│   │   │   ├── FileUpload.tsx    # 文件上传（拖拽支持）
│   │   │   └── DataPreview.tsx   # 数据预览
│   │   ├── analysis/
│   │   │   ├── AnalysisProgress.tsx    # 假设检验 6 步进度条
│   │   │   ├── AnalysisSteps.tsx       # 假设检验 6 步手风琴
│   │   │   ├── SpcProgress.tsx         # SPC 5 步进度条
│   │   │   ├── SpcSteps.tsx            # SPC 5 步手风琴
│   │   │   ├── StatCard.tsx            # 统计量卡片
│   │   │   ├── EffectSizeBar.tsx       # 效应量可视化条
│   │   │   ├── MethodBadge.tsx         # 方法标签
│   │   │   ├── Suggestions.tsx         # 分析建议
│   │   │   ├── ConclusionPanel.tsx     # 结论面板
│   │   │   └── VariablePickerDialog.tsx # 变量选择对话框
│   │   ├── charts/
│   │   │   └── ChartContainer.tsx      # ECharts 图表容器
│   │   └── export/
│   │       └── ExportButton.tsx        # 导出按钮
│   ├── stores/
│   │   ├── appStore.ts           # 应用全局状态
│   │   ├── chatStore.ts          # 对话与分析状态
│   │   ├── sessionStore.ts       # 会话与数据状态
│   │   └── configStore.ts        # 配置状态（持久化）
│   ├── api/
│   │   ├── chat.ts               # 对话接口
│   │   ├── upload.ts             # 上传接口
│   │   ├── export.ts             # 导出接口
│   │   ├── sessions.ts           # 会话接口
│   │   └── config.ts             # 配置接口
│   └── App.tsx
├── package.json
└── tsconfig.json
```

### 4.2 页面设计

#### Home.tsx — 主分析页面

主分析视图，承载核心交互流程。根据分析类型渲染不同的内容区域：

- `renderHypothesisContent()` — 渲染假设检验分析结果（6 步流程展示）
- `renderSpcContent()` — 渲染 SPC 控制图分析结果（5 步流程展示）
- 支持过程能力（Capability）与稳定性（Stability）内容渲染
- 通过 `useEffect` 自动调用 LLM 生成分析结论

#### History.tsx — 历史会话页面

会话浏览器，提供以下功能：

- 分页浏览历史分析会话
- 关键词搜索
- 按行业、时间等条件筛选

#### Settings.tsx — 系统设置页面

- 模型配置管理（选择供应商、填写 API Key、设置模型参数）
- 提示词模板编辑器

### 4.3 组件设计

#### 布局组件（layout）

| 组件 | 说明 |
|------|------|
| `Layout.tsx` | 全局页面布局框架 |
| `Header.tsx` | 顶部导航栏 |
| `Sidebar.tsx` | 侧边栏导航 |
| `ModuleSelector.tsx` | 分析模块切换选择器 |

#### 上传组件（upload）

| 组件 | 说明 |
|------|------|
| `FileUpload.tsx` | 文件上传组件，支持拖拽上传 |
| `DataPreview.tsx` | 数据预览表格，展示上传文件的前若干行 |

#### 分析组件（analysis）

| 组件 | 说明 |
|------|------|
| `AnalysisProgress.tsx` | 假设检验 6 步流程进度条（Stepper） |
| `AnalysisSteps.tsx` | 假设检验 6 步流程详情（Accordion） |
| `SpcProgress.tsx` | SPC 5 步流程进度条（Stepper） |
| `SpcSteps.tsx` | SPC 5 步流程详情（Accordion） |
| `StatCard.tsx` | 统计量展示卡片 |
| `EffectSizeBar.tsx` | 效应量大小可视化进度条 |
| `MethodBadge.tsx` | 统计方法名称标签 |
| `Suggestions.tsx` | 基于分析结果的后续建议 |
| `ConclusionPanel.tsx` | LLM 生成结论展示面板 |
| `VariablePickerDialog.tsx` | 变量选择对话框，用于选取分析列 |

#### 图表组件（charts）

| 组件 | 说明 |
|------|------|
| `ChartContainer.tsx` | ECharts 图表容器，支持散点图、箱线图、柱状图、分布图、残差图、控制图 |

#### 导出组件（export）

| 组件 | 说明 |
|------|------|
| `ExportButton.tsx` | 报告导出按钮，触发后端导出并下载 ZIP |

### 4.4 状态管理

使用 Zustand 进行轻量级状态管理，共分为 4 个 Store：

#### appStore

| 状态 | 类型 | 说明 |
|------|------|------|
| `activeModule` | string | 当前激活的分析模块 |

#### chatStore

| 状态 | 类型 | 说明 |
|------|------|------|
| `sessionId` | string | 当前会话 ID |
| `messages` | array | 消息列表 |
| `isLoading` | boolean | 是否正在加载 |
| `multiAnalysisResults` | array | 多次分析的结果集合 |
| `conclusion` | string | LLM 生成的分析结论 |

#### sessionStore

| 状态 | 类型 | 说明 |
|------|------|------|
| `sessions` | array | 会话列表 |
| `currentFile` | object | 当前上传的文件信息 |
| `dataSummary` | object | 数据摘要（列类型、统计量） |
| `industry` | string | 所属行业 |

#### configStore

| 状态 | 类型 | 说明 |
|------|------|------|
| `modelConfig` | object | 模型配置（供应商、API Key、参数） |
| `promptTemplates` | object | 提示词模板 |

> **持久化：** configStore 通过 Zustand 的 persist 中间件持久化至 localStorage，确保用户配置在刷新后不丢失。

### 4.5 API 通信层

基于 Axios 封装的 API 客户端，按业务模块拆分：

| 模块 | 文件 | 说明 |
|------|------|------|
| 对话分析 | `chat.ts` | 调用 `/api/v2/chat`，发送分析请求 |
| 文件上传 | `upload.ts` | 调用 `/api/v2/upload`，上传 CSV/Excel/TXT |
| 报告导出 | `export.ts` | 调用 `/api/v2/export`，获取导出的 ZIP 文件 |
| 会话管理 | `sessions.ts` | 调用 `/api/v2/sessions` 及 `/api/v2/session/{id}`，管理历史会话 |
| 系统配置 | `config.ts` | 调用 `/api/v2/config/*`，管理模型配置与提示词 |

---

## 5. 数据流

### 5.1 完整数据流程

```
┌────────────────────────────────────────────────────────────────────────────────┐
│                              数据流全景                                        │
├────────────────────────────────────────────────────────────────────────────────┤
│                                                                                │
│  ① 上传阶段                                                                   │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐     │
│  │ 用户拖拽  │───▶│ FileUpload   │───▶│ /api/v2/     │───▶│ data_loader  │     │
│  │ 文件上传  │    │ 组件         │    │ upload       │    │ 自动编码检测  │     │
│  └──────────┘    └──────────────┘    └──────────────┘    └──────┬───────┘     │
│                                                                  │             │
│                                                                  ▼             │
│                                                          ┌──────────────┐     │
│                                                          │ data_summary │     │
│                                                          │ 列类型推断    │     │
│                                                          └──────┬───────┘     │
│                                                                  │             │
│  ② 分析阶段                                                     ▼             │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐     │
│  │ 用户输入  │───▶│ intent.py    │───▶│ planner.py   │───▶│ engine/      │     │
│  │ 分析需求  │    │ 意图解析      │    │ 计划生成      │    │ methods.py   │     │
│  └──────────┘    └──────────────┘    └──────────────┘    │ spc.py       │     │
│                                                          └──────┬───────┘     │
│                                                                  │             │
│  ③ 展示阶段                                                     ▼             │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐     │
│  │ 用户查看  │◀──│ Home.tsx     │◀──│ chatStore    │◀──│ /api/v2/chat │     │
│  │ 分析结果  │    │ 渲染结果      │    │ 状态更新      │    │ 返回结果      │     │
│  └──────────┘    └──────────────┘    └──────────────┘    └──────────────┘     │
│                                                                                │
│  ④ 导出阶段                                                                   │
│  ┌──────────┐    ┌──────────────┐    ┌──────────────┐    ┌──────────────┐     │
│  │ 用户点击  │───▶│ ExportButton │───▶│ /api/v2/     │───▶│ exporter.py  │     │
│  │ 导出按钮  │    │ 组件         │    │ export       │    │ 生成报告+图片 │     │
│  └──────────┘    └──────────────┘    └──────────────┘    └──────────────┘     │
│                                                                                │
└────────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 各阶段详细说明

#### 阶段一：数据上传

1. 用户通过 `FileUpload` 组件拖拽或选择文件（CSV / Excel / TXT）
2. 前端调用 `/api/v2/upload` 接口上传文件
3. 后端 `data_loader.py` 加载文件，使用 chardet 自动检测编码（失败时回退至 GB18030）
4. `data_summary.py` 对每列进行类型推断，识别为 `bool`、`datetime`、`number`、`category` 或 `text`
5. 将文件信息与数据摘要存储至 SQLite，返回会话 ID 与摘要信息
6. 前端 `DataPreview` 组件展示数据预览

#### 阶段二：分析执行

1. 用户通过对话框输入分析需求（自然语言或 JSON 格式）
2. 前端调用 `/api/v2/chat` 接口
3. 后端 `intent.py` 解析用户意图（启发式规则 + LLM 辅助），进行模糊列名匹配
4. `planner.py` 将意图映射为执行计划，自动填充缺失参数
5. 根据计划调用 `engine/methods.py`（统计检验）或 `engine/spc.py`（SPC 控制图）
6. 分析结果（统计量、p 值、图表数据等）存储至 `MessageModel.analysis` 字段

#### 阶段三：结果展示

1. 后端返回分析结果，前端 `chatStore` 更新状态
2. `Home.tsx` 根据分析类型选择渲染方式：
   - 假设检验 → `renderHypothesisContent()`，展示 6 步流程
   - SPC → `renderSpcContent()`，展示 5 步流程与控制图
3. `ChartContainer.tsx` 使用 ECharts 渲染交互式图表
4. `useEffect` 自动触发 `/api/v2/report/conclusion` 调用 LLM 生成结论
5. `ConclusionPanel` 展示生成的分析结论

#### 阶段四：报告导出

1. 用户点击 `ExportButton` 触发导出
2. 前端调用 `/api/v2/export` 接口
3. 后端 `exporter.py` 执行：
   - 生成 Markdown 文本报告
   - 使用 Matplotlib 渲染图表为 PNG 图片（支持中文字体）
   - 使用 python-docx 构建 DOCX 文档
   - 将所有文件打包为 ZIP
4. 前端下载 ZIP 文件

---

## 6. 部署方案

### 6.1 Docker 部署

```
┌─────────────────────────────────────┐
│           Docker Container          │
│                                     │
│  ┌───────────────────────────────┐  │
│  │        Uvicorn (ASGI)         │  │
│  │                               │  │
│  │  ┌─────────────────────────┐  │  │
│  │  │     FastAPI 应用         │  │  │
│  │  │  (后端 API + 静态文件)   │  │  │
│  │  └─────────────────────────┘  │  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───────────────────────────────┐  │
│  │     SQLite 数据库文件          │  │
│  │     (Volume 挂载持久化)       │  │
│  └───────────────────────────────┘  │
│                                     │
│  ┌───────────────────────────────┐  │
│  │     上传文件存储目录           │  │
│  │     (Volume 挂载持久化)       │  │
│  └───────────────────────────────┘  │
│                                     │
└─────────────────────────────────────┘
```

### 6.2 部署步骤

1. **构建前端：** 在 `frontend/` 目录下执行 `npm run build`，生成静态文件
2. **构建 Docker 镜像：** 包含后端依赖与前端构建产物
3. **运行容器：** 通过 Docker 启动，使用 Uvicorn 作为 ASGI 服务器
4. **数据持久化：** 将 SQLite 数据库文件和上传文件目录通过 Docker Volume 挂载至宿主机

### 6.3 环境变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `DATABASE_URL` | 数据库连接字符串 | `sqlite:///./data/app.db` |
| `UPLOAD_DIR` | 上传文件存储路径 | `./data/uploads` |
| `EXPORT_DIR` | 导出文件临时路径 | `./data/exports` |
| `HOST` | 服务监听地址 | `0.0.0.0` |
| `PORT` | 服务监听端口 | `8000` |
