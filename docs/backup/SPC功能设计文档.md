# SPC  Agent  产品功能设计文档

**Statistical Process Control Intelligent Analysis Agent**

- 版本：V1.0
- 日期：2026年1月

---

## 1. 产品概述

### 1.1 产品定位

SPC智能分析Agent是一款开箱即用的统计过程控制智能分析产品，面向制造业、质量管理、数据分析等领域用户，提供自动化的数据分析、控制图选择、异常检测和预警服务。也可以提供API服务，供其他系统调用，提供智能分析的能力。

### 1.2 核心价值

- **零门槛使用**：用户无需具备SPC专业知识，上传数据即可获得专业分析结果
- **智能决策**：自动识别数据类型，智能匹配最优控制图类型
- **实时预警**：基于西联规则的异常检测引擎，实时发现过程异常
- **可视化呈现**：直观的控制图展示和异常点标注

### 1.3 目标用户

| 用户类型 | 典型场景 | 核心需求 |
|----------|----------|----------|
| 质量工程师 | 生产过程质量监控 | 快速发现过程异常，减少不良品 |
| 数据分析师 | 业务数据波动分析 | 识别数据趋势和异常模式 |
| 生产管理者 | 生产线稳定性监控 | 实时掌握生产状态，及时决策 |
| 研发工程师 | 实验数据分析 | 评估工艺稳定性和改进效果 |

---

## 2. 功能架构

### 2.1 整体流程

产品采用端到端的智能分析流程，用户只需上传数据，系统自动完成全部分析工作：

```
数据输入 → 属性判断 → 控制图选择 → 参数计算 → 图表绘制 → 异常检测 → 预警输出
```

### 2.2 功能模块

| 功能模块 | 功能说明 |
|----------|----------|
| 数据接入模块 | 支持Excel、CSV、API等多种数据源接入，自动解析数据结构 |
| 智能判断模块 | 自动识别数据类型（连续/离散）、样本量、数据分布特征 |
| 控制图引擎 | 根据判断结果自动选择并绘制最优控制图 |
| 异常检测引擎 | 基于西联规则的8条检测规则，实时扫描异常点 |
| 预警通知模块 | 异常发现后即时推送预警，支持多渠道通知 |
| 报告生成模块 | 自动生成分析报告，包含图表、结论和改进建议 |

---

## 3. 数据属性智能判断

### 3.1 判断逻辑

系统通过多维度特征分析，自动判断数据属性：

#### 3.1.1 数据类型判断

| 判断维度 | 判断条件 | 结果 |
|----------|----------|------|
| 数值唯一值占比 | 唯一值/总数 < 5% | 离散型 |
| 数据类型 | 整数且值域有限（如0/1、1-5） | 离散型 |
| 数值特征 | 包含小数、连续分布 | 连续型 |
| 业务语义 | 用户指定或字段名推断 | 辅助判断 |

#### 3.1.2 样本量识别

系统自动识别数据的子组结构和样本量：

- **单值数据（n=1）**：每个时间点或批次仅一个测量值
- **小样本子组（n<10）**：每个子组包含2-9个测量值
- **大样本子组（n≥10）**：每个子组包含10个或以上测量值

#### 3.1.3 离散数据细分

对于离散型数据，需进一步判断统计对象：

| 统计对象 | 定义 | 示例 |
|----------|------|------|
| 不合格品 | 整个产品不合格（二元判定） | 合格/不合格 |
| 缺陷数 | 单个产品可有多个缺陷 | 划痕数、气泡数 |

---

## 4. 控制图智能选择

### 4.1 控制图类型矩阵

基于数据属性判断结果，系统按以下决策矩阵自动选择控制图：

#### 4.1.1 连续型数据

| 样本量 | 统计量 | 控制图 | 组合使用 |
|--------|--------|--------|----------|
| n=1 | 个体值 | IX | IX-mR |
| n=1 | 移动极差 | mR | IX-mR |
| n<10（典型3~5） | 均值 | Xbar | Xbar-R |
| n<10（典型3~5） | 极差 | R | Xbar-R |
| n<10（典型3~5） | 中位数 | Xm | Xm-R |
| n≥10 | 均值 | Xbar | Xbar-σ |
| n≥10 | 标准差 | σ | Xbar-σ |

#### 4.1.2 离散型数据

| 统计对象 | 样本量条件 | 统计量 | 控制图 |
|----------|------------|--------|--------|
| 不合格品 | n≥50，可变 | 不合格品率 | P图 |
| 不合格品 | n≥50，固定 | 不合格品数 | NP图 |
| 缺陷数 | n>5，固定 | 缺陷数 | C图 |
| 缺陷数 | n可变 | 单位缺陷率 | U图 |

### 4.2 决策流程图

系统按以下决策树进行控制图选择：

```
                        输入数据
                           │
                    ┌──────┴──────┐
                    │  数据类型判断  │
                    └──────┬──────┘
              ┌────────────┴────────────┐
              ▼                         ▼
          连续型                      离散型
              │                         │
       ┌──────┴──────┐           ┌──────┴──────┐
       │  样本量判断  │           │ 对象类型判断 │
       └──────┬──────┘           └──────┬──────┘
    ┌─────┬───┴───┬─────┐      ┌───────┴───────┐
    ▼     ▼       ▼     ▼      ▼               ▼
  n=1   n<10    n≥10         不合格品         缺陷数
    │     │       │             │               │
    ▼     ▼       ▼             ▼               ▼
 IX-mR  Xbar-R  Xbar-σ       P/NP图          C/U图
```

---

## 5. 西联规则异常检测引擎

### 5.1 规则定义

系统内置8条西联规则（Western Electric Rules），用于检测过程异常：

| 规则 | 异常判定条件 | 检测目的 |
|------|--------------|----------|
| 1 | 1个点超出控制限（±3σ） | 检测突变/特殊原因 |
| 2 | 连续9点落在中心线同一侧 | 检测过程偏移 |
| 3 | 连续6点持续上升或下降 | 检测趋势 |
| 4 | 连续14点交替上下波动 | 检测非随机模式 |
| 5 | 连续3点中有2点落在±2σ与±3σ之间（同侧） | 检测分布偏移预警 |
| 6 | 连续5点中有4点落在±1σ与±3σ之间（同侧） | 检测方差变化 |
| 7 | 连续15点落在±1σ之内 | 检测分层/混合 |
| 8 | 连续8点落在±1σ之外（两侧均可） | 检测数据混合 |

### 5.2 检测逻辑

#### 5.2.1 区域划分

控制图分为三个区域，用于规则判定：

- **A区（警告区）**：距中心线2σ至3σ之间
- **B区（注意区）**：距中心线1σ至2σ之间
- **C区（正常区）**：距中心线0至1σ之间

#### 5.2.2 检测机制

系统采用滑动窗口方式实时检测：

1. 每个新数据点进入时，触发全部8条规则检测
2. 规则检测相互独立，并行执行
3. 任一规则触发即标记异常，记录触发的具体规则
4. 支持自定义启用/禁用特定规则

---

## 6. 预警机制

### 6.1 预警等级

| 等级 | 触发条件 | 响应建议 |
|------|----------|----------|
| 🔴 紧急 | 触发规则1（超出控制限） | 立即停机检查，识别特殊原因 |
| 🟠 警告 | 触发规则2、3、5、6 | 加强监控，准备干预措施 |
| 🟡 注意 | 触发规则4、7、8 | 记录观察，分析潜在原因 |

### 6.2 通知渠道

- **系统内通知**：控制图界面实时标注异常点，弹窗提醒
- **消息推送**：支持企业微信、钉钉、邮件等渠道
- **API回调**：支持webhook方式对接外部系统

### 6.3 预警信息

每条预警包含以下信息：

| 字段 | 说明 |
|------|------|
| 异常时间 | 数据点对应的时间戳 |
| 异常值 | 触发异常的具体数值 |
| 触发规则 | 具体触发的西联规则编号及名称 |
| 预警等级 | 紧急/警告/注意 |
| 控制图类型 | 当前使用的控制图类型 |
| 建议措施 | 基于规则类型的处理建议 |

---

## 7. 用户界面设计

### 7.1 主要页面

#### 7.1.1 数据上传页

- 支持拖拽上传Excel/CSV文件
- 数据预览和字段选择
- 可选：手动指定数据类型和样本量

#### 7.1.2 分析结果页

- 数据属性判断结果展示
- 控制图选择说明
- 交互式控制图（支持缩放、数据点悬停详情）

#### 7.1.3 预警中心

- 预警列表（按时间/等级排序）
- 预警详情和处理状态跟踪
- 历史预警统计分析

### 7.2 控制图展示规范

| 元素 | 展示规范 |
|------|----------|
| 中心线（CL） | 绿色实线，标注数值 |
| 控制上限（UCL） | 红色虚线，标注数值 |
| 控制下限（LCL） | 红色虚线，标注数值 |
| ±1σ线 | 黄色点线（可选显示） |
| ±2σ线 | 橙色点线（可选显示） |
| 数据点 | 蓝色圆点，异常点标红并放大 |
| 连接线 | 蓝色细线连接各数据点 |

---

## 8. 技术架构

### 8.1 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      前端展示层                              │
│        Web界面 / 移动端 / API对接 / 大屏展示                  │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────┴───────────────────────────────┐
│                      Agent服务层                             │
│  ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐   │
│  │ 数据判断   │ │ 图表选择   │ │ 异常检测   │ │ 预警服务   │   │
│  │  Agent    │ │  Agent    │ │  Agent    │ │  Agent    │   │
│  └───────────┘ └───────────┘ └───────────┘ └───────────┘   │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────┴───────────────────────────────┐
│                      计算引擎层                              │
│        统计计算 / 控制限计算 / 规则引擎 / 图表渲染             │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────┴───────────────────────────────┐
│                      数据层                                  │
│        数据接入 / 数据存储 / 缓存 / 消息队列                   │
└─────────────────────────────────────────────────────────────┘
```

### 8.2 技术选型建议

| 层级 | 技术组件 | 说明 |
|------|----------|------|
| 前端 | React/Vue + ECharts | 响应式界面，专业图表库 |
| Agent框架 | LangChain/自研框架 | Agent编排和调度 |
| 计算引擎 | Python + NumPy/Pandas | 高性能统计计算 |
| 后端服务 | FastAPI/Spring Boot | RESTful API服务 |
| 数据库 | SQLite + Redis | 单机轻量持久化（WAL 模式）和缓存 |
| 消息队列 | RabbitMQ/Kafka | 异步处理和预警推送 |
| 大模型 | 智普 GLM-4.6 | 中文优化，用于智能诊断与建议生成 |

---

## 9. 产品路线图

| 阶段 | 时间 | 核心功能 |
|------|------|----------|
| MVP | 第1-2月 | 数据上传、自动判断、基础控制图、西联规则检测 |
| V1.0 | 第3-4月 | 完整控制图类型、预警通知、分析报告生成 |
| V1.5 | 第5-6月 | API对接、批量分析、历史趋势对比 |
| V2.0 | 第7-8月 | 智能诊断建议、根因分析、预测性分析 |

---

## 10. 附录

### 10.1 术语表

| 术语 | 定义 |
|------|------|
| SPC | Statistical Process Control，统计过程控制 |
| UCL | Upper Control Limit，控制上限 |
| LCL | Lower Control Limit，控制下限 |
| CL | Center Line，中心线 |
| 西联规则 | Western Electric Rules，用于检测过程异常的统计规则 |
| σ（Sigma） | 标准差，衡量数据离散程度 |

### 10.2 参考文献

1. ISO 7870-2:2013 Control charts — Part 2: Shewhart control charts
2. Western Electric Company. Statistical Quality Control Handbook. 1956.
3. Montgomery, D.C. Introduction to Statistical Quality Control. 8th Edition.

| ??? | ?? GLM-4.6 | ???????????????? |
